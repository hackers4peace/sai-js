x-postgres-env: &postgres-env
  CSS_POSTGRES_CONNECTION_STRING: postgres://temporal:temporal@postgresql:5432/auth

x-vapid-env: &vapid-env
  CSS_VAPID_PUBLIC_KEY: BNUaG9vwp-WE_cX-3dNLebyczW_RivE8wHECIvZIUMUZ3co6P79neE3hueJJtFcg5ezTZ25T1ITciujz-mlAcnY
  CSS_VAPID_PRIVATE_KEY: 8d8mM59L2VptBg5hX_2dHnQ7T5VpeUsftbaQ6PfuhGA
  CSS_PUSH_SENDER: mailto:example@yourdomain.org

x-idp-env: &idp-env
  CSS_ENCODED_PRIVATE_JWK: eyJrdHkiOiJFQyIsIngiOiJDMjlsZmlGbm5OV3RITHplSkxDVXpiQnN3QVJCOVZoSl9fRlBWZFlTY3FRIiwieSI6InIxVFpMQS1zbWxyOUkzSWdfc1dRcTM5R0ZjbUYwOVF6TTU3SUs4d1BxUlkiLCJjcnYiOiJQLTI1NiIsImQiOiJYcHdmRDlkN1gtc1FySWlrRW5rWE9KalVKb1JjZS1zS2ZvLXkxdkxIamVjIiwiYWxnIjoiRVMyNTYifQ

x-sparql-env: &sparql-env
  CSS_SPARQL_ENDPOINT: http://sparql/sparql

x-certs-env: &certs-env
  NODE_EXTRA_CA_CERTS: /mkcert/rootCA.pem

x-temporal-env: &temporal-env
  TEMPORAL_ADDRESS: temporal:7233

x-origin-env: &origin-env
  CSS_ID_ORIGIN: id.docker
  CSS_DOC_ORIGIN: id.docker
  CSS_DATA_ORIGIN: data.docker
  CSS_REG_ORIGIN: reg.docker

services:
  auth:
    image: node:22-alpine
    container_name: auth
    restart: on-failure
    networks:
      - default
    dns:
      - 172.16.0.253
    expose:
      - 4800
    ports:
      - "9229:9229"
    working_dir: /sai/packages/css-storage-fixture
    command:
      - node
      - --inspect=0.0.0.0:9229
      - /sai/node_modules/@solid/community-server/bin/server.js
    volumes:
      - ./:/sai
      - ${CAROOT}:/mkcert
    environment:
      <<:
        [
          *postgres-env,
          *vapid-env,
          *idp-env,
          *sparql-env,
          *certs-env,
          *temporal-env,
          *origin-env,
        ]
      CSS_CONFIG: /sai/packages/css-storage-fixture/auth.json
      CSS_LOGGING_LEVEL: debug
      CSS_BASE_URL: https://auth.docker/
      CSS_AUTHORIZATION_ENDPOINT: https://ui.auth.docker/authorize
      CSS_PORT: 4800
    labels:
      - traefik.enable=true
      - traefik.http.routers.auth.rule=Host(`auth.docker`)
      - traefik.http.routers.auth.entrypoints=websecure
      - traefik.http.routers.auth.tls=true
      - traefik.http.services.auth.loadbalancer.server.port=4800
      - traefik.http.middlewares.testheader.headers.customrequestheaders.X-Forwarded-Proto=https
  registry:
    image: node:22-alpine
    container_name: registry
    restart: on-failure
    networks:
      - default
    dns:
      - 172.16.0.253
    expose:
      - 4600
    ports:
      - "9230:9230"
    working_dir: /sai/packages/css-storage-fixture
    command:
      - node
      - --inspect=0.0.0.0:9230
      - /sai/node_modules/@solid/community-server/bin/server.js
    volumes:
      - ./:/sai
      - ${CAROOT}:/mkcert
    environment:
      <<: [*postgres-env, *sparql-env, *certs-env]
      CSS_CONFIG: /sai/packages/css-storage-fixture/registry.json
      CSS_LOGGING_LEVEL: info
      CSS_BASE_URL: https://reg.docker/
      CSS_PORT: 4600
    labels:
      - traefik.enable=true
      - traefik.http.routers.registry.rule=Host(`reg.docker`)
      - traefik.http.routers.registry.entrypoints=websecure
      - traefik.http.routers.registry.tls=true
      - traefik.http.services.registry.loadbalancer.server.port=4600
      - traefik.http.middlewares.testheader.headers.customrequestheaders.X-Forwarded-Proto=https
  data:
    image: node:22-alpine
    container_name: data
    restart: on-failure
    networks:
      - default
    dns:
      - 172.16.0.253
    expose:
      - 4700
    ports:
      - "9231:9231"
    working_dir: /sai/packages/css-storage-fixture
    command:
      - node
      - --inspect=0.0.0.0:9231
      - /sai/node_modules/@solid/community-server/bin/server.js
    volumes:
      - ./:/sai
      - ${CAROOT}:/mkcert
    environment:
      <<: [*postgres-env, *sparql-env, *certs-env]
      CSS_CONFIG: /sai/packages/css-storage-fixture/data.json
      CSS_LOGGING_LEVEL: info
      CSS_ROOT_FILE_PATH: /sai/packages/css-storage-fixture/dev/data
      CSS_BASE_URL: https://data.docker/
      CSS_PORT: 4700
    labels:
      - traefik.enable=true
      - traefik.http.routers.data.rule=Host(`data.docker`) || HostRegexp(`^.+\.data\.docker$`)
      - traefik.http.routers.data.entrypoints=websecure
      - traefik.http.routers.data.tls=true
      - traefik.http.services.data.loadbalancer.server.port=4700
      - traefik.http.middlewares.testheader.headers.customrequestheaders.X-Forwarded-Proto=https
  worker:
    image: node:22-slim
    container_name: worker
    restart: on-failure
    networks:
      - default
    dns:
      - 172.16.0.253
    ports:
      - "9235:9235"
    working_dir: /sai/packages/components
    command:
      - node
      - --inspect=0.0.0.0:9235
      - /sai/packages/components/dist/workers/main.js
    volumes:
      - ./:/sai
      - ${CAROOT}:/mkcert
    environment:
      <<: [*postgres-env, *vapid-env, *idp-env, *certs-env, *temporal-env]
      CSS_BASE_URL: https://auth.docker/
  ui:
    image: node:22-alpine
    container_name: ui
    restart: on-failure
    networks:
      - default
    expose:
      - 4200
    working_dir: /sai/ui/authorization
    command: ["npm", "run", "dev"]
    volumes:
      - ./:/sai
    labels:
      - traefik.enable=true
      - traefik.http.routers.ui-sai.rule=Host(`ui.auth.docker`)
      - traefik.http.routers.ui-sai.entrypoints=websecure
      - traefik.http.routers.ui-sai.tls=true
      - traefik.http.services.ui-sai.loadbalancer.server.port=4200
  vuejectron:
    image: node:22-alpine
    container_name: vuejectron
    restart: on-failure
    networks:
      - default
    expose:
      - 4500
    working_dir: /sai/examples/vuejectron
    command: ["npm", "run", "dev"]
    volumes:
      - ./:/sai
    labels:
      - traefik.enable=true
      - traefik.http.routers.vuejectron.rule=Host(`vuejectron.docker`)
      - traefik.http.routers.vuejectron.entrypoints=websecure
      - traefik.http.routers.vuejectron.tls=true
      - traefik.http.services.vuejectron.loadbalancer.server.port=4500

  router:
    image: traefik:v3.6.5
    container_name: router
    restart: on-failure
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/conf/traefik.yml:/etc/traefik/traefik.yml
      - ./traefik/certs/cert.pem:/etc/traefik/cert.pem
      - ./traefik/certs/key.pem:/etc/traefik/key.pem
    labels:
      - traefik.enable=true
      - traefik.http.routers.router.rule=Host(`router${SHARED_DOMAIN_SEGMENT}.docker`)
      - traefik.http.routers.router.entrypoints=websecure
      - traefik.http.services.router.loadbalancer.server.port=8080
      - traefik.http.routers.router.tls=true
    healthcheck:
      test: ["CMD-SHELL", "traefik healthcheck --ping"]
      interval: 4s
      timeout: 4s
      retries: 8
      start_period: 4s
    networks:
      default:
        ipv4_address: 172.16.0.250

  dns:
    image: drpsychick/dnsmasq:latest
    container_name: dnsmasq
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "53:53/tcp"
      - "53:53/udp"
    cap_add:
      - NET_ADMIN
    healthcheck:
      test: ["CMD-SHELL", "nslookup localhost 127.0.0.1 || exit 1"]
      interval: 4s
      timeout: 4s
      retries: 8
      start_period: 4s
    networks:
      default:
        ipv4_address: 172.16.0.253

  postgresql:
    image: postgres:${POSTGRESQL_VERSION}
    container_name: postgresql
    environment:
      POSTGRES_PASSWORD: temporal
      POSTGRES_USER: temporal
    networks:
      - default
    ports:
      - 5432:5432
    expose:
      - 5432 # internal only
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U temporal"]
      interval: 5s
      timeout: 5s
      retries: 60
      start_period: 30s

  temporal-admin-tools:
    image: temporalio/admin-tools:${TEMPORAL_ADMINTOOLS_VERSION}
    container_name: temporal-admin-tools
    restart: on-failure:6
    depends_on:
      postgresql:
        condition: service_healthy
    environment:
      - DB=postgres12
      - DB_PORT=5432
      - POSTGRES_USER=temporal
      - POSTGRES_PWD=temporal
      - POSTGRES_SEEDS=postgresql
      - SQL_PASSWORD=temporal
    networks:
      - default
    volumes:
      - ./temporal/setup-postgres.sh:/etc/temporal/setup-postgres.sh
    entrypoint: ["/bin/sh"]
    command: /etc/temporal/setup-postgres.sh

  temporal:
    image: temporalio/server:${TEMPORAL_VERSION}
    container_name: temporal
    depends_on:
      temporal-admin-tools:
        condition: service_completed_successfully
    environment:
      - DB=postgres12
      - DB_PORT=5432
      - POSTGRES_USER=temporal
      - POSTGRES_PWD=temporal
      - POSTGRES_SEEDS=postgresql
      - BIND_ON_IP=0.0.0.0
      - DYNAMIC_CONFIG_FILE_PATH=/etc/temporal/development-sql.yaml
    networks:
      - default
    ports:
      - 7233:7233
    volumes:
      - ./temporal/development.yaml:/etc/temporal/development-sql.yaml
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "7233"]
      interval: 5s
      timeout: 3s
      start_period: 30s
      retries: 60

  temporal-create-namespace:
    image: temporalio/admin-tools:${TEMPORAL_ADMINTOOLS_VERSION}
    container_name: temporal-create-namespace
    restart: on-failure:5
    depends_on:
      temporal:
        condition: service_healthy
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - DEFAULT_NAMESPACE=default
    networks:
      - default
    volumes:
      - ./temporal/create-namespace.sh:/etc/temporal/create-namespace.sh
    entrypoint: ["/bin/sh"]
    command: /etc/temporal/create-namespace.sh

  temporal-ui:
    image: temporalio/ui:${TEMPORAL_UI_VERSION}
    container_name: temporal-ui
    depends_on:
      temporal:
        condition: service_healthy
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_CORS_ORIGINS=http://localhost:3000
    networks:
      - default
    ports:
      - 8080:8080
    labels:
      - traefik.enable=true
      - traefik.http.routers.temporal-ui.rule=Host(`temporal.docker`)
      - traefik.http.routers.temporal-ui.entrypoints=websecure
      - traefik.http.routers.temporal-ui.tls=true
      - traefik.http.services.temporal-ui.loadbalancer.server.port=8080

  oxigraph:
    image: oxigraph/oxigraph:latest
    container_name: oxigraph
    restart: on-failure
    networks:
      - default
    environment:
      - RUST_LOG=debug
    expose:
      - 7878 # internal only
    command: ["serve", "--location", "/data", "--bind", "0.0.0.0:7878"]

  sparql:
    image: nginx:alpine
    container_name: sparql
    restart: on-failure
    networks:
      - default
    depends_on:
      - oxigraph
    ports:
      - 7878:80
    volumes:
      - ./packages/css-storage-fixture/oxigraph.nginx.conf:/etc/nginx/nginx.conf:ro

  id:
    image: node:24-alpine
    container_name: id
    restart: on-failure
    networks:
      - default
    depends_on:
      - router
      - sparql
    volumes:
      - ./:/sai
    ports:
      - "9236:9236"
    command:
      - node
      - --inspect=0.0.0.0:9236
      - /sai/services/id/http.ts
    environment:
      <<: *sparql-env
      ID_ORIGIN: id.docker
      DOC_ORIGIN: id.docker
      # TODO: reuse CSS_ in origin-env
    labels:
      - traefik.enable=true
      - traefik.http.routers.id.rule=Host(`id.docker`) || HostRegexp(`^.+\.id\.docker$`)
      - traefik.http.routers.id.entrypoints=websecure
      - traefik.http.routers.id.tls=true
      - traefik.http.services.id.loadbalancer.server.port=3000

networks:
  default:
    name: network.${COMPOSE_PROJECT_NAME}
    ipam:
      config:
        - subnet: 172.16.0.0/16
          gateway: 172.16.0.1
